nmap -p- target.ip -oN nmap.ports
PORTS=$(cat nmap.ports | grep 'open' | awk '{ print $1 }' | awk '{print ($0+0)}' | sed -z 's/\n/,/g;s/,$/\n/')

for i in $(echo $PORTS | sed "s/,/ /g")
do
    nmap -sV -sC -p $i -oN nmap.$i target.ip
done
